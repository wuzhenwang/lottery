<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŠ½å¥–æ–¹æ¡ˆ</title>
    <!-- å¯¼å…¥ bootstrap çš„æ ·å¼è¡¨ -->
    <!-- https://v4.bootcss.com/docs/components/forms/#switches -->
    <link rel="stylesheet" href="./lib/bootstrap.css" />
    <style>
      :root {
        font-size: 13px;
      }
      body {
        padding: 8px;
      }
    </style>
  </head>
  <body>
    <script src="./lib/ajax.js"></script>
<!--    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>-->
    <script src="./lib/axios.min.js"></script>
    <div id="app">
      <!-- å¡ç‰‡åŒºåŸŸ -->
      <div class="card">
        <h5 class="card-header">æ·»åŠ æ–¹æ¡ˆ</h5>
        <div class="card-body">
          <!-- æ·»åŠ æ–¹æ¡ˆçš„è¡¨å• -->
          <form class="form-inline" @submit.prevent>
            <div class="input-group mb-2 mr-sm-2">
              <div class="input-group-prepend">
                <div class="input-group-text">åç§°</div>
              </div>
              <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
              <input type="text" class="form-control" placeholder="ä¾‹ï¼šæ–¹æ¡ˆä¸€" v-model="name" @keyup.enter="addPrizePlan" />
              <div class="input-group-prepend">
                <div class="input-group-text">æ ‡è¯†</div>
              </div>
              <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
              <input type="text" class="form-control" placeholder="ä¾‹ï¼šé«˜äºŒ3ç­" v-model="mark" @keyup.enter="addPrizePlan" />

<!--              <input type="file" id="file">-->
<!--              <button onclick="doUpload()">å¼€å§‹ä¸Šä¼ </button>-->
<!--              <img src="" alt="">-->

              <div class="upload">
                <input type="file" id="excel" single @change="upload" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel">
              </div>
            </div>

            <!-- æäº¤è¡¨å•çš„æŒ‰é’® -->
            <button type="submit" class="btn btn-primary mb-2" @click="addPrizePlan">æ·»åŠ æ–¹æ¡ˆ</button>
          </form>

        </div>
      </div>
      <!-- æ–¹æ¡ˆåˆ—è¡¨ -->
      <table class="table table-bordered table-striped mt-2">
        <thead>
          <tr>
            <th>å‹¾é€‰æ¡†</th>
            <th>id</th>
            <th>åç§°</th>
            <th>æ ‡è¯†</th>
            <th>çŠ¶æ€</th>
            <th>æŠ½å¥–äººå‘˜Excelæ–‡ä»¶è·¯å¾„</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æ›´æ–°æ—¶é—´</th>
          </tr>
        </thead>
        <!-- è¡¨æ ¼çš„ä¸»ä½“åŒºåŸŸ -->
        <tbody>
          <!-- TODOï¼šå¾ªç¯æ¸²æŸ“è¡¨æ ¼çš„æ¯ä¸€è¡Œæ•°æ® -->
          <tr v-for="(item,i) in prizePlans" :key="item.id">
            <td><input type="checkbox" @click="selectPlan(item.id)"/></td>
            <td>{{ item.id }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.mark }}</td>
            <td>{{ item.state }}</td>
            <td>
                <div>
                    {{ item.userFilePath }}
                    <button style="float: right" class="btn btn-primary mb-2" @click="download(item.userFilePath)">ä¸‹è½½</button>
                </div>
            </td>
            <td>{{ item.created_at }}</td>
            <td>{{ item.updated_at }}</td>
            <td>
              <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" :id="item.id" v-model="item.state" @click="changePlanState(item.id, item.state)">
                <label class="custom-control-label" :for="item.id" v-if="item.state">å·²å¯ç”¨</label>
                <label class="custom-control-label" :for="item.id" v-else>å·²ç¦ç”¨</label>
              </div>
            </td>
<!--            <td>{{ item.Datetime | datafamat }}</td>-->
            <td>
              <a href="#" @click="planDelete(item.id,i)">åˆ é™¤</a>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- å¡ç‰‡åŒºåŸŸ -->
      <div class="card">
        <h5 class="card-header">æ·»åŠ å¥–é¡¹</h5>
        <div class="card-body">
          <!-- æ·»åŠ å¥–å“çš„è¡¨å• -->
          <form class="form-inline" @submit.prevent>
            <div class="input-group mb-2 mr-sm-2">
              <div class="input-group-prepend">
                <div class="input-group-text">åç§°</div>
              </div>
              <input type="text" class="form-control" placeholder="ä¾‹ï¼šé’¢ç¬”" v-model="prize.title" @keyup.enter="addPrize" />

              <div class="input-group-prepend">
                <div class="input-group-text">å¥–é¡¹ç±»åˆ«</div>
              </div>
              <Select placeholder="è¯·é€‰æ‹©" class="form-control" v-model="prize.type" ref="newText" @change="selectType">
                <Option v-for="(item,index) in typeData" :key="item.title" :value="item.type">{{item.title}}</Option>
              </Select>

              <div class="input-group-prepend">
                <div class="input-group-text">æ•°é‡</div>
              </div>
              <input type="number" class="form-control" placeholder="" v-model="prize.count" @keyup.enter="addPrize" />

              <div class="input-group-prepend">
                <div class="input-group-text">æ¯æ¬¡æŠ½å–æ•°é‡</div>
              </div>
              <input type="number" class="form-control" placeholder="" v-model="prize.eachCount" @keyup.enter="addPrize" />

              <div class="upload">
                <input type="file" id="img" single @change="upload" accept="image/*">
              </div>
            </div>

            <!-- æäº¤è¡¨å•çš„æŒ‰é’® -->
            <button type="submit" class="btn btn-primary mb-2" @click="addPrize">æ·»åŠ å¥–é¡¹</button>
          </form>

        </div>
      </div>
      <!-- å¥–å“åˆ—è¡¨ -->
      <table class="table table-bordered table-striped mt-2">
        <thead>
        <tr>
<!--          <th>å¥–å“id</th>-->
          <th>æ–¹æ¡ˆid</th>
          <th>åç§°</th>
          <th>ç±»å‹</th>
          <th>å¥–åˆ«</th>
          <th>æ•°é‡</th>
          <th>æ¯æ¬¡æŠ½å–æ•°é‡</th>
<!--          <th>å¥–å“å›¾ç‰‡</th>-->
          <th>åˆ›å»ºæ—¶é—´</th>
          <th>æ›´æ–°æ—¶é—´</th>
        </tr>
        </thead>
        <!-- è¡¨æ ¼çš„ä¸»ä½“åŒºåŸŸ -->
        <tbody>
        <tr v-for="(item,i) in prizes" :key="item.id">
<!--          <td>{{ item.id }}</td>-->
          <td>{{ item.planId }}</td>
          <td>{{ item.title }}</td>
          <td>{{ item.type }}</td>
          <td>{{ item.text }}</td>
          <td>{{ item.count }}</td>
          <td>{{ item.eachCount }}</td>
<!--          <td>{{ item.img }}</td>-->
          <td>{{ item.created_at }}</td>
          <td>{{ item.updated_at }}</td>
          <!--            <td>{{ item.Datetime | datafamat }}</td>-->
          <td>
            <div>
              <img :src="item.img" width="50" height="50">
            </div>
          </td>
          <td>
            <a href="#" @click="prizeDelete(item,i)">åˆ é™¤</a>
          </td>
        </tr>
        </tbody>
      </table>
      <div>
        <div style="float: right">
          <a href="/" class="btn btn-primary mb-2" >è¿”å›æŠ½å¥–é¡µ</a>
        </div>
      </div>
    </div>

    <script src="./lib/vue-2.6.12.js"></script>
    <script>

      function doUpload() {
        let file = $('#file').get(0).files[0];
        //åˆ›å»ºç©ºçš„formDataå¯¹è±¡
        var formdata = new FormData();
        //  formdata.appendçš„å±æ€§å è¦å’Œåç«¯ä¿æŒä¸€è‡´ `file`
        formdata.append('file', file, file.name);
        console.log(formdata.get('file'))
        $.ajax({
          url: '/uploadImage',
          type: 'POST',
          data: formdata,
          processData:false,
          contentType: false,
          success: function (data) {
            console.log(data)
            // $('img').attr('src', data.data.url);
          }
        })
      };
      const Vm = new Vue({
        el:'#app',
        data:{
          name: '',
          mark: '',
          userFilePath: '',
          prizePlans:[{}],
          prizes:[],
          planId: '',
          prize: {},
          typeData: [
            {'type': 1,'title': 'ç‰¹ç­‰å¥–'},
            {'type': 2,'title': 'ä¸€ç­‰å¥–'},
            {'type': 3,'title': 'äºŒç­‰å¥–'},
            {'type': 4,'title': 'ä¸‰ç­‰å¥–'},
            {'type': 5,'title': 'å››ç­‰å¥–'},
            {'type': 6,'title': 'äº”ç­‰å¥–'},
            {'type': 7,'title': 'å…­ç­‰å¥–'}
          ]
        },
        created(){
          this.getPrizePlan();
        },
        methods: {
          getPrizePlan() {
            let that = this;
            window.AJAX({
              url: "/prize/getPlan",
              type: "GET",
              success(res) {
                that.prizePlans = res.prizePlan
              }
            });
          },
          planDelete(id,i) {
            if(id == 1 || id == 2) return alert('ç«Ÿç„¶è¦åˆ æ‰äººå®¶ï¼Œå¿ƒç—›ğŸ’”ğŸ’”ğŸ’”')
            let that = this;
            window.AJAX({
              url: "/prize/deletePlan?id="+id,
              type: "GET",
              success(res) {
                that.prizePlans.splice(i,1)
              }
            });

          },
          addPrizePlan() {
            if(!this.name) return alert('åç§°ä¸èƒ½ä¸ºç©º')
            if(!this.mark) return alert('æ ‡è¯†ä¸èƒ½ä¸ºç©º')
            if(!this.userFilePath) return alert('äººå‘˜æ–‡ä»¶ä¸èƒ½ä¸ºç©º')
            let that = this;
            let plan_id;
            window.AJAX({
              url: "/prize/createPlan",
              data: {
                name: that.name,
                mark: that.mark,
                userFilePath: that.userFilePath
              },
              success(res) {
                alert('æ·»åŠ æˆåŠŸ');
                that.prizePlans.push(res)
                plan_id = res.id
                // location.reload();
                window.AJAX({
                  url: "/prize/create",
                  data: {
                    planId: plan_id,
                    type: 0,
                    text:'ç‰¹åˆ«å¥–',
                    title: '',
                    count: '200',
                    eachCount: '1'
                  },
                  success(res) {
                    console.log('åˆå§‹0å¥–å“æˆåŠŸ')
                    location.reload();
                  }
                });
              }
            });
          },
          upload(e) {
            let file = e.target.files[0];
            console.log(file)//è¿™ä¸ªå°±æ˜¯é€‰ä¸­æ–‡ä»¶ä¿¡æ¯
            let formdata = new FormData();
            formdata.append('file', file, file.name);
            let that = this;
            // å‘é€ POST è¯·æ±‚
            axios({
              method: 'post',
              url: '/api/uploadImage',
              data: formdata,
              Headers: {
                "content-type": "multipart/form-data",
              }
            }).then(function (res){
              console.log(res.data.data);
              if (file.type.indexOf('image') > -1) {
                that.prize.img = res.data.data.url;
              } else {
                that.userFilePath = res.data.data.url;
              }
            }).catch(function (err){
              console.log('é”™è¯¯')
            });
          },
          changePlanState(id, state) {
            console.log(id+""+state)
            let that = this;
            window.AJAX({
              url: "/prize/changePlanState",
              data: {
                id: id,
                state: !state
              },
              success(res) {
                console.log(res)
                alert('æ­å–œæ‚¨çŠ¶æ€æ”¹æˆåŠŸäº†');
                // location.reload();
                window.AJAX({
                  url: "/reset",
                  success(res) {
                    console.log('ä¿®æ”¹çŠ¶æ€åï¼Œæ•°æ®é‡ç½®')
                  }
                });
              }
            });
          },
          prizeDelete(item,i) {
            if (item.type == 0 || item.planId == 1 || item.planId == 2) {
              return alert('ä¸ºä»€ä¹ˆè¦åˆ æ‰äººå®¶ï¼Ÿå¥½ç‹ çš„å¿ƒâ¤ï¸')
            }
            let that = this;
            window.AJAX({
              url: "/prize/delete?id="+item.id,
              type: "GET",
              success(res) {
                that.prizes.splice(i,1)
              }
            });
          },
          selectPlan(id) {
            this.planId = id;
            console.log('æ‰“å°é€‰ä¸­çš„idï¼š'+id)
            let that = this;
            window.AJAX({
              url: "/prize/get?planId="+id,
              type: "GET",
              success(res) {
                that.prizes = res.prize
              }
            });
          },
          addPrize() {
            if (!this.planId) return alert('ä¸é€‰æ–¹æ¡ˆçš„è¯ï¼Œé‚£ç©¶ç«Ÿç»™å“ªä¸ªå“ŸğŸ§ğŸ§ğŸ§â“â“â“')
            this.prize.planId = this.planId
            if (!this.prize.type) return alert('å¥½æ­¹é€‰ä¸ªç±»åˆ«å˜›ï¼ŒğŸ¤£ğŸ¤£ğŸ¤£')
            if (!this.prize.count) return alert('æ²¡æœ‰æ•°é‡éš¾é“æŠ½ç©ºæ°”å˜›ï¼ŒğŸ¤¤ğŸ¤¤ğŸ¤¤')
            if (!this.prize.title) return alert('æ— åæ°å˜›ğŸ§ğŸ§ğŸ§â“â“â“')
            if (!this.prize.img) return alert('ä¸ç»™ä¸ªå›¾ç‰‡å˜›ï¼ŸğŸ¤ªğŸ¤ªğŸ¤ª')
            console.log(this.prize)
            let that = this;
            window.AJAX({
              url: "/prize/create",
              data: that.prize,
              success(res) {
                that.prizes.push(res)
                that.prize = {}
              }
            });
          },
          selectType() {
            //å¾—åˆ°é€‰ä¸­value
            console.log(this.$refs.newText.value)
            this.typeData.forEach(item =>{
              if (item.type == this.prize.type) {
                this.prize.text = item.title;
              }
            })
            console.log(JSON.stringify(this.prize))
          },
          download(path) {
              if(!path) return alert('ä½ çœŸçš„ç¡®å®šæœ‰å¯ä¾›ä¸‹è½½çš„æ–‡ä»¶ï¼Ÿâ‰ï¸â™Œï¸â™Œï¸')
              let index = path.lastIndexOf("\/");
              let fileName = path.substring(index + 1,path.length);
              axios.get('/api/download?file='+fileName, {
                  responseType: 'blob',
              }).then(res => {
                  const blob = new Blob([res.data]);//å¤„ç†æ–‡æ¡£æµ
                  const elink = document.createElement('a');
                  elink.download = fileName;
                  elink.style.display = 'none';
                  elink.href = URL.createObjectURL(blob);
                  document.body.appendChild(elink);
                  elink.click();
                  URL.revokeObjectURL(elink.href); // é‡Šæ”¾URL å¯¹è±¡
                  document.body.removeChild(elink);
              })
          },




        }
      })
    </script>
  </body>
</html>
